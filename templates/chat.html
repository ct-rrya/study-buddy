{% extends "base.html" %}
{% block title %}Chat with {{ friend.username }} - Study Buddy{% endblock %}

{% block content %}
<div class="chat-container" data-theme="{{ chat_theme or 'purple' }}">
    <div class="chat-header">
        <a href="{{ url_for('social.friends_page') }}" class="back-btn">
            <i class="iconoir-arrow-left"></i> Back
        </a>
        <div class="chat-header-info">
            <img src="{{ friend.get_avatar_url() }}" alt="{{ friend.username }}" class="chat-friend-avatar">
            <h1>{{ friend.username }}</h1>
        </div>
        <button class="btn btn-small theme-toggle-btn" onclick="toggleThemePicker()">
            <i class="iconoir-palette"></i> Theme
        </button>
    </div>
    
    <div id="theme-picker" class="theme-picker hidden">
        <div class="theme-options">
            {% for t in ['purple', 'blue', 'green', 'pink', 'orange', 'cyan'] %}
            <button class="theme-btn {{ 'active' if (chat_theme or 'purple') == t else '' }}" 
                    onclick="setTheme('{{ t }}')" title="{{ t|capitalize }}">
                <span class="theme-preview {{ t }}"></span>
            </button>
            {% endfor %}
        </div>
    </div>
    
    <div id="chat-messages" class="chat-messages">
        <div class="chat-bg-shapes">
            <span class="shape shape-1"></span>
            <span class="shape shape-2"></span>
            <span class="shape shape-3"></span>
            <span class="shape shape-4"></span>
        </div>
        {% for msg in messages %}
        <div class="message {{ 'sent' if msg.sender_id == current_user.id else 'received' }}">
            <div class="message-content">{{ msg.content }}</div>
            <div class="message-time">{{ msg.sent_at.strftime('%H:%M') }}</div>
        </div>
        {% endfor %}
    </div>
    
    <div class="chat-input-container">
        <input type="text" id="message-input" placeholder="Type a message...">
        <button onclick="sendMessage()" class="send-btn">
            <i class="iconoir-send"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const friendId = {{ friend.id }};
const currentUserId = {{ current_user.id }};
let typingTimeout;

// Join the chat room
socket.emit('join_chat', {friend_id: friendId});

// Handle incoming messages
socket.on('new_message', (msg) => {
    // Only add if we didn't send it (sender already sees their message)
    if (msg.sender_id !== currentUserId) {
        addMessage(msg.content, false, msg.sent_at_formatted);
    }
});

// Handle typing indicators
socket.on('user_typing', (data) => {
    showTypingIndicator(data.username);
});

socket.on('user_stop_typing', () => {
    hideTypingIndicator();
});

function sendMessage() {
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    if (!content) return;
    
    // Send via Socket.IO
    socket.emit('send_message', {
        receiver_id: friendId,
        content: content
    });
    
    // Immediately show the message (optimistic UI)
    addMessage(content, true);
    input.value = '';
    
    // Stop typing indicator
    socket.emit('stop_typing', {friend_id: friendId});
}

function addMessage(content, isSent, time = null) {
    const div = document.createElement('div');
    div.className = `message ${isSent ? 'sent' : 'received'}`;
    const displayTime = time || new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    div.innerHTML = `
        <div class="message-content">${escapeHtml(content)}</div>
        <div class="message-time">${displayTime}</div>
    `;
    document.getElementById('chat-messages').appendChild(div);
    div.scrollIntoView({behavior: 'smooth'});
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showTypingIndicator(username) {
    let indicator = document.getElementById('typing-indicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'typing-indicator';
        indicator.className = 'typing-indicator';
        document.getElementById('chat-messages').appendChild(indicator);
    }
    indicator.innerHTML = `<span>${username} is typing...</span>`;
    indicator.style.display = 'block';
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

function toggleThemePicker() {
    document.getElementById('theme-picker').classList.toggle('hidden');
}

function setTheme(theme) {
    fetch(`/chat/theme/${friendId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({theme: theme})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.querySelector('.chat-container').dataset.theme = theme;
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.theme-btn[onclick="setTheme('${theme}')"]`).classList.add('active');
            document.getElementById('theme-picker').classList.add('hidden');
            showToast('Theme updated!', 'success');
        }
    });
}

const messageInput = document.getElementById('message-input');

messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

// Typing indicator logic
messageInput.addEventListener('input', () => {
    socket.emit('typing', {friend_id: friendId});
    
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        socket.emit('stop_typing', {friend_id: friendId});
    }, 1000);
});

// Leave chat room when navigating away
window.addEventListener('beforeunload', () => {
    socket.emit('leave_chat', {friend_id: friendId});
});

// Scroll to bottom on load
document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
</script>
{% endblock %}
